{
  "properties": {
      "displayName": "Deploy a single Recovery Services Vault per region with virtual machines",
      "policyType": "Custom",
      "mode": "All",
      "description": "This policy ensures that a single Recovery Services Vault is deployed in each region where virtual machines exist.",
      "metadata": {
          "category": "Backup"
      },
      "parameters": {},
      "policyRule": {
          "if": {
              "allOf": [
                  {
                      "field": "type",
                      "equals": "Microsoft.Compute/virtualMachines"
                  }
              ]
          },
          "then": {
              "effect": "deployIfNotExists",
              "details": {
                  "type": "Microsoft.RecoveryServices/vaults",
                  "roleDefinitionIds": [
                      "/providers/Microsoft.Authorization/roleDefinitions/9980e02c-c2be-4d73-94e8-173b1dc7cf3c",
                      "/providers/Microsoft.Authorization/roleDefinitions/5e467623-bb1f-42f4-a55d-6e525e11384b"
                  ],
                  "existenceCondition": {
                      "field": "Microsoft.RecoveryServices/vaults/location",
                      "equals": "[field('location')]"
                  },
                  "deployment": {
                      "properties": {
                          "mode": "incremental",
                          "template": {
                              "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                              "contentVersion": "1.0.0.0",
                              "resources": [
                                  {
                                      "name": "[concat('RSVault-', field('location'), '-', uniqueString(subscription().subscriptionId, resourceGroup().id, field('location')))]",
                                      "type": "Microsoft.RecoveryServices/vaults",
                                      "apiVersion": "2016-06-01",
                                      "location": "[field('location')]",
                                      "properties": {},
                                      "sku": {
                                          "name": "Standard"
                                      }
                                  }
                              ]
                          }
                      }
                  }
              }
          }
      }
  }
}
