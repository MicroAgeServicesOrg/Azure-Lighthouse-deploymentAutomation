{
  "kind": "template",
  "properties": {
    "displayName": "datadog_ARM",
    "description": "",
    "dependsOn": [],
    "template": {
      "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
      "contentVersion": "1.0.0.0",
      "metadata": {
        "_generator": {
          "name": "bicep",
          "version": "0.14.85.62628",
          "templateHash": "5700172118670018368"
        }
      },
      "parameters": {
        "location": {
          "type": "string",
          "metadata": {
            "description": "Required. Sets the location of the deployment. Resources in modules typically follow the locaiton of the RG"
          }
        },
        "clientPrefix": {
          "type": "string",
          "metadata": {
            "description": "Required. typical 3 digit client code for naming purposes"
          }
        },
        "childOrgApiKey": {
          "type": "string",
          "metadata": {
            "description": "Required. DataDog Specific Parameter"
          }
        },
        "childOrgAppKey": {
          "type": "string",
          "metadata": {
            "description": "Required. DataDog Specific Parameter"
          }
        }
      },
      "variables": {
        "namingConvention": "[format('{0}-{1}', parameters('clientPrefix'), parameters('location'))]"
      },
      "resources": [
        {
          "type": "Microsoft.Resources/resourceGroups",
          "apiVersion": "2021-04-01",
          "name": "[format('{0}-datadog-rg', variables('namingConvention'))]",
          "location": "[parameters('location')]"
        },
        {
          "type": "Microsoft.Resources/deployments",
          "apiVersion": "2020-10-01",
          "name": "datadogDeploy",
          "resourceGroup": "[format('{0}-datadog-rg', variables('namingConvention'))]",
          "properties": {
            "expressionEvaluationOptions": {
              "scope": "inner"
            },
            "mode": "Incremental",
            "parameters": {
              "location": {
                "value": "[parameters('location')]"
              },
              "clientPrefix": {
                "value": "[parameters('clientPrefix')]"
              },
              "childOrgApiKey": {
                "value": "[parameters('childOrgApiKey')]"
              },
              "childOrgApplicationKey": {
                "value": "[parameters('childOrgAppKey')]"
              }
            },
            "template": {
              "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
              "contentVersion": "1.0.0.0",
              "metadata": {
                "_generator": {
                  "name": "bicep",
                  "version": "0.14.85.62628",
                  "templateHash": "11115880146505884687"
                }
              },
              "parameters": {
                "location": {
                  "type": "string",
                  "defaultValue": "[resourceGroup().location]",
                  "metadata": {
                    "description": "Optional. Location for all resources."
                  }
                },
                "clientPrefix": {
                  "type": "string",
                  "metadata": {
                    "description": "Required. 3-4 digit client code"
                  }
                },
                "childOrgApiKey": {
                  "type": "string",
                  "metadata": {
                    "description": "Required. API Key for organization from DataDog"
                  }
                },
                "childOrgApplicationKey": {
                  "type": "string",
                  "metadata": {
                    "description": "Required. Application Key for organization from DataDog"
                  }
                }
              },
              "variables": {
                "namingConvention": "[format('{0}-{1}', parameters('clientPrefix'), parameters('location'))]"
              },
              "resources": [
                {
                  "type": "Microsoft.Datadog/monitors",
                  "apiVersion": "2022-06-01",
                  "name": "[format('{0}-datadog-prod', variables('namingConvention'))]",
                  "location": "[parameters('location')]",
                  "tags": {
                    "owner": "microageservices"
                  },
                  "sku": {
                    "name": "Linked"
                  },
                  "properties": {
                    "datadogOrganizationProperties": {
                      "apiKey": "[parameters('childOrgApiKey')]",
                      "applicationKey": "[parameters('childOrgApplicationKey')]"
                    },
                    "monitoringStatus": "Enabled",
                    "userInfo": {
                      "emailAddress": "infosec@microageservices.com",
                      "name": "MicroAge Services",
                      "phoneNumber": "800-544-8877"
                    }
                  }
                }
              ]
            }
          },
          "dependsOn": [
            "[subscriptionResourceId('Microsoft.Resources/resourceGroups', format('{0}-datadog-rg', variables('namingConvention')))]"
          ]
        }
      ]
    },
    "parameters": {
      "location": {
        "value": "[parameters('datadog_ARM_location')]"
      },
      "clientPrefix": {
        "value": "[parameters('datadog_ARM_clientPrefix')]"
      },
      "childOrgApiKey": {
        "value": "[parameters('datadog_ARM_childOrgApiKey')]"
      },
      "childOrgAppKey": {
        "value": "[parameters('datadog_ARM_childOrgAppKey')]"
      }
    }
  }
}