{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.25.53.49325",
      "templateHash": "11485173938541431801"
    }
  },
  "parameters": {
    "location": {
      "type": "string",
      "defaultValue": "westus2"
    },
    "vmName": {
      "type": "string",
      "defaultValue": "wu2-testvm01"
    },
    "vmRgName": {
      "type": "string",
      "defaultValue": "masvc-wu2-test-rg"
    },
    "clientCode": {
      "type": "string",
      "defaultValue": "masvc"
    }
  },
  "variables": {
    "backupFabric": "Azure",
    "backupPolicy": "azMSPVMBackupPolicy",
    "v2VMType": "Microsoft.Compute/virtualMachines",
    "v2Vm": "vm;iaasvmcontainerv2;",
    "vaultName": "[take(format('{0}-{1}-centralVault', parameters('clientCode'), parameters('location')), 50)]"
  },
  "resources": [
    {
      "type": "Microsoft.RecoveryServices/vaults",
      "apiVersion": "2023-06-01",
      "name": "[variables('vaultName')]",
      "location": "[parameters('location')]",
      "sku": {
        "name": "Standard"
      },
      "properties": {
        "publicNetworkAccess": "Enabled"
      }
    },
    {
      "type": "Microsoft.RecoveryServices/vaults/backupPolicies",
      "apiVersion": "2023-06-01",
      "name": "[format('{0}/{1}', variables('vaultName'), variables('backupPolicy'))]",
      "location": "[parameters('location')]",
      "properties": {
        "backupManagementType": "AzureIaasVM",
        "policyType": "V2",
        "instantRPDetails": {},
        "instantRpRetentionRangeInDays": 2,
        "protectedItemsCount": 0,
        "retentionPolicy": {
          "dailySchedule": {
            "retentionDuration": {
              "count": 30,
              "durationType": "Days"
            },
            "retentionTimes": [
              "2024-02-21T22:00:00Z"
            ]
          },
          "monthlySchedule": {
            "retentionDuration": {
              "count": 12,
              "durationType": "Months"
            },
            "retentionScheduleFormatType": "Weekly",
            "retentionScheduleWeekly": {
              "daysOfTheWeek": [
                "Sunday"
              ],
              "weeksOfTheMonth": [
                "First"
              ]
            },
            "retentionTimes": [
              "2024-02-21T22:00:00Z"
            ]
          },
          "retentionPolicyType": "LongTermRetentionPolicy",
          "weeklySchedule": {
            "daysOfTheWeek": [
              "Sunday"
            ],
            "retentionDuration": {
              "count": 4,
              "durationType": "Weeks"
            },
            "retentionTimes": [
              "2024-02-21T22:00:00Z"
            ]
          },
          "yearlySchedule": {
            "monthsOfYear": [
              "January"
            ],
            "retentionDuration": {
              "count": 3,
              "durationType": "Years"
            },
            "retentionScheduleFormatType": "Weekly",
            "retentionScheduleWeekly": {
              "daysOfTheWeek": [
                "Sunday"
              ],
              "weeksOfTheMonth": [
                "First"
              ]
            },
            "retentionTimes": [
              "2024-02-21T22:00:00Z"
            ]
          }
        },
        "schedulePolicy": {
          "schedulePolicyType": "SimpleSchedulePolicyV2",
          "dailySchedule": {
            "scheduleRunTimes": [
              "2024-02-21T22:00:00Z"
            ]
          },
          "scheduleRunFrequency": "Daily"
        },
        "tieringPolicy": {
          "ArchivedRP": {
            "tieringMode": "TierRecommended"
          }
        },
        "timeZone": "Pacific Standard Time"
      },
      "dependsOn": [
        "[resourceId('Microsoft.RecoveryServices/vaults', variables('vaultName'))]"
      ]
    }
  ]
}